#!/bin/bash

# ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ë•Œ ì‚¬ìš©ìë¡œë¶€í„° ë°›ì€ ì²« ë²ˆì§¸ ì¸ìë¥¼ message_file ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤. ì´ ì¸ìëŠ” ì»¤ë°‹ ë©”ì‹œì§€ê°€ ìˆëŠ” íŒŒì¼ì˜ ê²½ë¡œì…ë‹ˆë‹¤.
message_file="$1"
# í˜„ì¬ Git ì €ì¥ì†Œì˜ ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ git_dir ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
git_dir=$(git rev-parse --git-dir)

# `message_file` ë³€ìˆ˜ì— ì €ì¥ëœ íŒŒì¼ì„ ì½ì–´ì„œ message ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤. ì´ëŠ” ì»¤ë°‹ ë©”ì‹œì§€ ë‚´ìš©ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
message=$(cat "$message_file")
# í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë¸Œëœì¹˜ì˜ ì´ë¦„ì„ current_branch ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
current_branch=$(git rev-parse --abbrev-ref HEAD)
# `services` ë³€ìˆ˜ì—ëŠ” ì¼ë ¨ì˜ ì„œë¹„ìŠ¤ ì´ë¦„ì„ ì •ê·œ í‘œí˜„ì‹ìœ¼ë¡œ ë‚˜íƒ€ë‚¸ ë¬¸ìì—´ì´ ì €ì¥ë©ë‹ˆë‹¤.
# services='(alba-talk|business|personal|services|shared|root)'
# `default_pattern` ë³€ìˆ˜ì—ëŠ” ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì¼ì •í•œ íŒ¨í„´ì„ ë”°ë¥´ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ ì •ê·œ í‘œí˜„ì‹ì´ ì €ì¥ë©ë‹ˆë‹¤. ì´ íŒ¨í„´ì€ ë‹¤ì–‘í•œ ì‘ì—… ìœ í˜• (Add, Remove, Fix ë“±)ì„ í¬í•¨í•˜ë©°, ì„ íƒì ìœ¼ë¡œ services ë¬¸ìì—´ê³¼ ì¼ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# default_pattern="^(\($services\) )?(Add|Remove|Fix|Modify|Improve|Simplify|Refactor|Merge|Move)"
default_pattern="^(\(Add|Remove|Fix|Modify|Improve|Simplify|Refactor|Merge|Move\) )"
# `ticket_pattern` ë³€ìˆ˜ì—ëŠ” í‹°ì¼“ ë²ˆí˜¸ íŒ¨í„´ì„ ì •ê·œ í‘œí˜„ì‹ìœ¼ë¡œ ë‚˜íƒ€ë‚¸ ë¬¸ìì—´ì´ ì €ì¥ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, "FRONTEND-123"ê³¼ ê°™ì€ í‹°ì¼“ ë²ˆí˜¸ë¥¼ ë‚˜íƒ€ë‚´ëŠ” í˜•ì‹ì…ë‹ˆë‹¤.
ticket_pattern='FRONTEND-[0-9]+'
# ì´ˆê¸°ì— ë¹ˆ ë¬¸ìì—´ë¡œ ì´ˆê¸°í™”ëœ ë³€ìˆ˜ì…ë‹ˆë‹¤.
target_service=''
# ì´ˆê¸°ì— ë¹ˆ ë¬¸ìì—´ë¡œ ì´ˆê¸°í™”ëœ ë³€ìˆ˜ì…ë‹ˆë‹¤.
target_ticket=''




# Git ì €ì¥ì†Œì—ì„œ Rebase ì‘ì—…ì´ ì§„í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ëŠ” ì¡°ê±´ë¬¸ì…ë‹ˆë‹¤. ë§Œì•½ Rebase ì‘ì—… ì¤‘ì´ë¼ë©´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¦‰ì‹œ ì¢…ë£Œí•©ë‹ˆë‹¤.
# if test -d "$git_dir/rebase-merge"; then
#   # Rebase in progress
#   # Exit immediately
#   exit 0
# fi




# ì»¤ë°‹ ë©”ì‹œì§€ê°€ default_patternì— ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ í™•ì¸í•˜ëŠ” ì¡°ê±´ë¬¸ì…ë‹ˆë‹¤. ì´ ê²½ìš°, ì»¤ë°‹ ë©”ì‹œì§€ê°€ ì§€ì •ëœ ê·œì¹™ì„ ë”°ë¥´ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²½ê³  ë©”ì‹œì§€ê°€ ì¶œë ¥ë˜ê³  ìŠ¤í¬ë¦½íŠ¸ê°€ ì¢…ë£Œë©ë‹ˆë‹¤.
if [[ ! $message =~ $default_pattern ]]; then
  echo 'ğŸš¨ Git ì»¨ë²¤ì…˜ì„ ì¤€ìˆ˜í•´ì£¼ì„¸ìš”! ğŸ‘®'
#   echo 'https://wiki.jobkorea.co.kr/display/FEDEV/Git'
  echo ''
  echo 'ğŸƒ      ğŸš“ğŸ’¨ğŸ’¨'
  osascript -e 'display notification "ğŸš¨ Git ì»¨ë²¤ì…˜ì„ ì¤€ìˆ˜í•´ì£¼ì„¸ìš”! ğŸ‘®" with title "ì»¨ë²¤ì…˜ ê²½ê³ "'
  exit 1
fi




# ì»¤ë°‹ ë©”ì‹œì§€ê°€ `services` ë¬¸ìì—´ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ í™•ì¸í•˜ëŠ” ì¡°ê±´ë¬¸ì…ë‹ˆë‹¤. 
# ì´ ê²½ìš°, ë³€ê²½ëœ íŒŒì¼ ì¤‘ì—ì„œ apps ë˜ëŠ” libs ë””ë ‰í† ë¦¬ì—ì„œ í•´ë‹¹ `services`ì— í•´ë‹¹í•˜ëŠ” ê²ƒì„ ì°¾ì•„ë‚´ê³ , ê·¸ ì¤‘ ê°€ì¥ ë¹ˆë„ìˆ˜ê°€ ë†’ì€ ì„œë¹„ìŠ¤ë¥¼ target_service ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤. 
# ë””ë ‰í† ë¦¬ì—ì„œ íŒŒì¼ì„ ê²€ìƒ‰í•˜ê¸° ìœ„í•´ ì •ê·œ í‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ê³ , grep ë° awkë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
# if [[ ! $message =~ ^\($services\) ]]; then
#   tmp=()
#   files_changed=$(git diff --name-only HEAD)
#   dir_pattern="(apps|libs)\/$services"

#   # I can't use -P in mac's default bash ;(
#   # grep -P -E -o '(apps|libs)\/\K(alba-talk|business|personal|services|shared)' <<<$files_changed | sort -r | uniq -c | sort -n | tail -1

#   for file in $files_changed; do
#     if [[ $file =~ $dir_pattern ]]; then
#       service="${BASH_REMATCH[2]}"
#       tmp+=("$service")
#     fi
#   done

#   if ((${#tmp[@]})); then
#     target_service=$(printf '%s\n' "${tmp[@]}" | sort -r | uniq -c | sort -n | tail -1 | awk '{print $2}')
#     # Yes I think this is so weird, but I'm noob to bash.
#     # And to be honest, bash has always been weird too.
#     target_service="($target_service) "
#   else
#     target_service="(root) "
#   fi
# fi




# ì»¤ë°‹ ë©”ì‹œì§€ì— `ticket_pattern` íŒ¨í„´ì´ í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì€ ê²½ìš°ë¥¼ í™•ì¸í•˜ëŠ” ì¡°ê±´ë¬¸ì…ë‹ˆë‹¤. í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ `ticket_pattern`ê³¼ ì¼ì¹˜í•˜ëŠ” í‹°ì¼“ ë²ˆí˜¸ë¥¼ ì¶”ì¶œí•˜ì—¬ target_ticket ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
# if [[ ! $message =~ \[$ticket_pattern\]$ ]]; then
#   if [[ $current_branch =~ $ticket_pattern ]]; then
#     target_ticket="

# [${BASH_REMATCH[0]}]"
#   fi
# fi



#  ìµœì¢…ì ìœ¼ë¡œ, `target_service`, `message`, `target_ticket`ì„ ì¡°í•©í•˜ì—¬ ìƒˆë¡œìš´ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ê³ , ì´ë¥¼ `message_file`ì— ë®ì–´ì”ë‹ˆë‹¤.
# echo "$target_service$message$target_ticket" >$message_file




# ìŠ¤í¬ë¦½íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” ì½”ë“œì…ë‹ˆë‹¤.
exit 0
